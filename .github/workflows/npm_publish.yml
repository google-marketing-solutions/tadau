# Copyright 2024 Google LLC.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Publish Package to npmjs

on:
  push:
    branches: [main]
    paths: [ts]
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repo
        id: checkout-repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_ACCESS_TOKEN }}

      - name: Setup Node
        id: setup-node-publish
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Compare npm with local (versions).
        id: package_version
        uses: Rober19/compare-npm-versions-ci@master
        with:
          path: './ts'
          npm_package_name: tadau

      - name: Echo version numbers.
        run: |
          echo "Version is  ${{ steps.package_version.outputs.version }} "
          echo "Version NPM is  ${{ steps.package_version.outputs.pkg_npm_version }} "

      - name: Increment commit package npm version equal or greater than npm version.
        id: increment_version
        if: steps.package_version.outputs.npm_is_greater == 'true'
        run: |
          echo "Committed package version is not up to date. Incrementing version..."
          cd ts
          git config --global user.name 'maximilianw-google'
          git config --global user.email 'maximilianw@google.com'
          npm version patch -m "Set package version to %s"
          git push

      - name: Publish Package.
        id: publish_package
        run: |
          cd ts
          npm ci
          npm run build
          npm test
          npm publish --provenance --access public